# Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis

Sample:
MD5 Hash: c63a537090d34f29daadbef221637435
Malware Family: Locky Ransomware
Download: [[app.any.run]](https://app.any.run/tasks/08b994be-89b1-4890-98e7-018d8d133a7b/)<br/>
Download: [[Github]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/Advanced_Memory_Forensics_Threat_Hunting_and_Malware_Analysis/svchost.zip)<br/>

Video [part1]: [[Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis [part1]]](https://youtu.be/tAn-Wm27Tww)<br/>
Video [part2]: [[Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis [part2]]](https://youtu.be/tAn-Wm27Tww)<br/>


## Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis [part1]:<br/>

Video: [[Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis [part1]]](https://youtu.be/tAn-Wm27Tww)<br/>
<br/>

### Content:
Tools
Usual steps
Threat_Hunting using Volatility3 and Yara_rules
PE Dumping and repairing

### Covered in Video [part1]:
MAGNET Encrypted Disk Detector (EDD)
MAGNET RAM Capture (Recommended)
Volatility3
Yara_rules (Malpedia: "https://malpedia.caad.fkie.fraunhofer.de/api/get/yara/auto/zip", Github:"https://github.com/Yara-Rules/rules")
Yara-rules merger: https://github.com/Dump-GUY/Powershell-Tools/blob/master/yara_rule_merger.ps1
pe-tree-vol
pe_unmapper


### Tools:

#### Encryption detection:
-MAGNET Encrypted Disk Detector (EDD)

#### Memory Acquisition (Tools):
-MAGNET RAM Capture (Recommended)
-Belkasoft Live RAM Capturer (Recommended) 
-WinPmem (Recommended)
-FTK Imager


#### Memory analysis (Tools):
-Volatility2 (Python latest)
-Volatility3 (Python latest) or (VolatilityWorkbench - OSForensics GUI for Volatility3)
-Rekall
-Redline
-Bulk_Extractor + BEViewer
-HEX Editor (010editor, FileInsight+Plugins, HxD)
-Yara_rules

#### Dumped PE repairing tools:
-Pe-Tree tools (pe-tree-vol.exe), Volatility2/3, pe_unmapper

#### Malware Analysis tools:
-All kind of usual malware analysis tools
-Yara + Yara_rules
-CAPA
-IDA Free/Pro
-Ghidra
-Cutter
-x64dbg
-PE-bear, pestudio, CFF Explorer, ResourceHacker
-Strings (Floss, Strings2, FlareStrings, StringSifter)


### Guide:
EDD - check if not encrypted Volume (Keys in memory so no problem if yes)
Perform Memdump
Powershell + volatility3 commands:
$mempath = "C:\Users\DFIR_GUY\Desktop\Advanced_Memory_forensics_Threat_Hunting\DUMPED\exercise_memdump.raw"  (Set variable to memdump path)
.\vol.py -h (help)
.\vol.py -f $mempath windows.info.Info  (OS info)
.\vol.py -f $mempath windows.pslist.PsList (Process info)
.\vol.py -f $mempath windows.pstree.PsTree (Process tree info)
.\vol.py -f $mempath windows.dlllist.DllList --pid 3076 (Obtain process loaded dlls and full system path of main module)
.\vol.py -f $mempath windows.handles.Handles --pid 3076
.\vol.py -f $mempath windows.netscan.NetScan | Select-String "3076" (Network related artifacts only for our suspicious Process PID)
.\vol.py -f $mempath windows.vadyarascan.VadYaraScan -h (To obtain help about plugin)
.\vol.py -f $mempath windows.vadyarascan.VadYaraScan --yara-file C:\Users\DFIR_GUY\Desktop\Advanced_Memory_forensics_Threat_Hunting\Yara_Rules\Malware_merged.yar --pid 3076
.\vol.py -f $mempath windows.vadinfo.VadInfo --pid 3076 (VAD = Virtual Address Descriptor - Lists process memory ranges and enables to dump them)
.\vol.py -f $mempath windows.vadinfo.VadInfo --pid 3076 | Select-String "\svchost.exe" -SimpleMatch (get VAD info only about main module of svchost.exe process)
.\vol.py -f $mempath windows.vadinfo.VadInfo --pid 3076 --address 0x400000 --dump (dump Memory range of main module svchost.exe process - specify start address obtain by previous command)

Perform yara scan of memdump to confirm detected malware family: yara32.exe ..\Yara_Rules\malpedia_merged.yar .\pid.3076.vad.0x400000-0x41cfff.dmp

Dumping PE and repaire for analysis:
.\pe_unmapper64.exe /in ..\DUMPED\pid.3076.vad.0x400000-0x41cfff.dmp.bin /base 400000 /out pe_unmapper.exe.bin
.\vol.py -f $mempath windows.pslist.PsList --pid 3076 --dump (Perform procdump - dumping main module of process - Automatically repaire module (VA to RAW + IAT repaire) not like dumping memory)
 pe-tree-vol.exe $mempath






## Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis [part2]:<br/>

Video: [[Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis [part2]]](https://youtu.be/tAn-Wm27Tww)<br/>

### Content:
Initial static file analysis of dumped PE
Initial Malware analysis and RE of dumped PE

### Covered in Video [part2]:
PE-bear, pestudio
FlareStrings, StringSifter
CAPA
IDA Pro


### Initial static file analysis:
Pe-bear
Pestudio
flarestrings.exe .\pe_unmapper.exe | rank_strings.exe -s

### Initial Malware analysis and RE
CAPA
IDA Pro


## References:
MAGNET Encrypted Disk Detector (EDD) - https://www.magnetforensics.com/resources/encrypted-disk-detector/
MAGNET RAM Capture - https://www.magnetforensics.com/resources/magnet-ram-capture/
Belkasoft Live RAM Capturer - https://belkasoft.com/ram-capturer
WinPmem (Recommended) - https://github.com/Velocidex/WinPmem
FTK Imager - https://accessdata.com/product-download/ftk-imager-version-4-5
Volatility2 - https://github.com/volatilityfoundation/volatility
Volatility3 - https://github.com/volatilityfoundation/volatility3
VolatilityWorkbench - https://www.osforensics.com/tools/volatility-workbench.html
Rekall - https://github.com/google/rekall
Redline - https://www.fireeye.com/services/freeware/redline.html
Bulk_Extractor + BEViewer - http://www.kazamiya.net/en/bulk_extractor-rec
010editor - https://www.sweetscape.com/download/010editor/
FileInsight+Plugins - https://github.com/nmantani/FileInsight-plugins
HxD -
Yara -
Yara_rules (Malpedia) - https://malpedia.caad.fkie.fraunhofer.de/api/get/yara/auto/zip
Yara_rules (Github) - https://github.com/Yara-Rules/rules
Yara-rules merger - https://github.com/Dump-GUY/Powershell-Tools/blob/master/yara_rule_merger.ps1
Pe-Tree (pe-tree-volatility3) -
pe_unmapper -
CAPA -
IDA Free/Pro -
Ghidra -
Cutter -
x64dbg -
PE-bear -
pestudio -
CFF Explorer -
ResourceHacker -
Floss -
Strings2 -
FlareStrings -
StringSifter -


