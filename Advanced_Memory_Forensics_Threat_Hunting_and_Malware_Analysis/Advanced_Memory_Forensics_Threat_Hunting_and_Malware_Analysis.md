# Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis

### Sample:
MD5 Hash: c63a537090d34f29daadbef221637435<br/>
Malware Family: Locky Ransomware<br/>
Download: [[app.any.run]](https://app.any.run/tasks/08b994be-89b1-4890-98e7-018d8d133a7b/)<br/>
Download: [[Github]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/Advanced_Memory_Forensics_Threat_Hunting_and_Malware_Analysis/svchost.zip)<br/>

Video [part1]: [[Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis [part1]]](https://youtu.be/tAn-Wm27Tww)<br/>
Video [part2]: [[Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis [part2]]](https://youtu.be/tAn-Wm27Tww)<br/>
<br/>
## Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis [part1]:<br/>

Video: [[Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis [part1]]](https://youtu.be/tAn-Wm27Tww)<br/>
<br/>

### Content:
Tools<br/>
Usual steps<br/>
Threat_Hunting using Volatility3 and Yara_rules<br/>
PE Dumping and repairing<br/>

### Covered in Video [part1]:
MAGNET Encrypted Disk Detector (EDD)<br/>
MAGNET RAM Capture (Recommended)<br/>
Volatility3<br/>
Yara_rules (Malpedia: "https://malpedia.caad.fkie.fraunhofer.de/api/get/yara/auto/zip", Github:"https://github.com/Yara-Rules/rules")<br/>
Yara-rules merger: https://github.com/Dump-GUY/Powershell-Tools/blob/master/yara_rule_merger.ps1<br/>
pe-tree-vol<br/>
pe_unmapper<br/>


### Tools:

#### Encryption detection:
-MAGNET Encrypted Disk Detector (EDD)<br/>

#### Memory Acquisition (Tools):
-MAGNET RAM Capture (Recommended)<br/>
-Belkasoft Live RAM Capturer (Recommended)<br/>
-WinPmem (Recommended)<br/>
-FTK Imager<br/>

#### Memory analysis (Tools):
-Volatility2 (Python latest)<br/>
-Volatility3 (Python latest) or (VolatilityWorkbench - OSForensics GUI for Volatility3)<br/>
-Rekall<br/>
-Redline<br/>
-Bulk_Extractor + BEViewer<br/>
-HEX Editor (010editor, FileInsight+Plugins, HxD)<br/>
-Yara_rules<br/>

#### Dumped PE repairing tools:
-Pe-Tree tools (pe-tree-vol.exe), Volatility2/3, pe_unmapper<br/>

#### Malware Analysis tools:
-All kind of usual malware analysis tools<br/>
-Yara + Yara_rules<br/>
-CAPA<br/>
-IDA Free/Pro<br/>
-Ghidra<br/>
-Cutter<br/>
-x64dbg<br/>
-PE-bear, pestudio, CFF Explorer, ResourceHacker<br/>
-Strings (Floss, Strings2, FlareStrings, StringSifter)<br/>


### Guide:
EDD - check if not encrypted Volume (Keys in memory so no problem if yes)<br/>
Perform Memdump<br/>
Powershell + volatility3 commands:<br/>
$mempath = "C:\Users\DFIR_GUY\Desktop\Advanced_Memory_forensics_Threat_Hunting\DUMPED\exercise_memdump.raw"  (Set variable to memdump path)<br/>
.\vol.py -h (help)<br/>
.\vol.py -f $mempath windows.info.Info  (OS info)<br/>
.\vol.py -f $mempath windows.pslist.PsList (Process info)<br/>
.\vol.py -f $mempath windows.pstree.PsTree (Process tree info)<br/>
.\vol.py -f $mempath windows.dlllist.DllList --pid 3076 (Obtain process loaded dlls and full system path of main module)<br/>
.\vol.py -f $mempath windows.handles.Handles --pid 3076<br/>
.\vol.py -f $mempath windows.netscan.NetScan | Select-String "3076" (Network related artifacts only for our suspicious Process PID)<br/>
.\vol.py -f $mempath windows.vadyarascan.VadYaraScan -h (To obtain help about plugin)<br/>
.\vol.py -f $mempath windows.vadyarascan.VadYaraScan --yara-file C:\Users\DFIR_GUY\Desktop\Advanced_Memory_forensics_Threat_Hunting\Yara_Rules\Malware_merged.yar --pid 3076<br/>
.\vol.py -f $mempath windows.vadinfo.VadInfo --pid 3076 (VAD = Virtual Address Descriptor - Lists process memory ranges and enables to dump them)<br/>
.\vol.py -f $mempath windows.vadinfo.VadInfo --pid 3076 | Select-String "\svchost.exe" -SimpleMatch (get VAD info only about main module of svchost.exe process)<br/>
.\vol.py -f $mempath windows.vadinfo.VadInfo --pid 3076 --address 0x400000 --dump (dump Memory range of main module svchost.exe process - specify start address obtain by previous command)<br/>

Perform yara scan of memdump to confirm detected malware family: yara32.exe ..\Yara_Rules\malpedia_merged.yar .\pid.3076.vad.0x400000-0x41cfff.dmp<br/>

Dumping PE and repaire for analysis:<br/>
.\pe_unmapper64.exe /in ..\DUMPED\pid.3076.vad.0x400000-0x41cfff.dmp.bin /base 400000 /out pe_unmapper.exe.bin<br/>
.\vol.py -f $mempath windows.pslist.PsList --pid 3076 --dump (Perform procdump - dumping main module of process - Automatically repaire module (VA to RAW + IAT repaire) not like dumping memory)<br/>
 pe-tree-vol.exe $mempath<br/>


## Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis [part2]:<br/>

Video: [[Advanced Memory Forensics (Windows) - Threat_Hunting and Initial Malware_Analysis [part2]]](https://youtu.be/tAn-Wm27Tww)<br/>

### Content:
Initial static file analysis of dumped PE<br/>
Initial Malware analysis and RE of dumped PE<br/>

### Covered in Video [part2]:
PE-bear, pestudio<br/>
FlareStrings, StringSifter<br/>
CAPA<br/>
IDA Pro<br/>

### Initial static file analysis:
Pe-bear<br/>
Pestudio<br/>
flarestrings.exe .\pe_unmapper.exe | rank_strings.exe -s<br/>

### Initial Malware analysis and RE
CAPA<br/>
IDA Pro<br/>


## References:
MAGNET Encrypted Disk Detector (EDD) - https://www.magnetforensics.com/resources/encrypted-disk-detector/<br/>
MAGNET RAM Capture - https://www.magnetforensics.com/resources/magnet-ram-capture/<br/>
Belkasoft Live RAM Capturer - https://belkasoft.com/ram-capturer<br/>
WinPmem (Recommended) - https://github.com/Velocidex/WinPmem<br/>
FTK Imager - https://accessdata.com/product-download/ftk-imager-version-4-5<br/>
Volatility2 - https://github.com/volatilityfoundation/volatility<br/>
Volatility3 - https://github.com/volatilityfoundation/volatility3<br/>
VolatilityWorkbench - https://www.osforensics.com/tools/volatility-workbench.html<br/>
Rekall - https://github.com/google/rekall<br/>
Redline - https://www.fireeye.com/services/freeware/redline.html<br/>
Bulk_Extractor + BEViewer - http://www.kazamiya.net/en/bulk_extractor-rec<br/>
010editor - https://www.sweetscape.com/download/010editor/<br/>
FileInsight+Plugins - https://github.com/nmantani/FileInsight-plugins<br/>
HxD - https://mh-nexus.de/en/hxd/<br/>
Yara - https://github.com/VirusTotal/yara<br/>
Yara_rules (Malpedia) - https://malpedia.caad.fkie.fraunhofer.de/api/get/yara/auto/zip<br/>
Yara_rules (Github) - https://github.com/Yara-Rules/rules<br/>
Yara-rules merger - https://github.com/Dump-GUY/Powershell-Tools/blob/master/yara_rule_merger.ps1<br/>
Pe-Tree (pe-tree-volatility3) - https://github.com/blackberry/pe_tree<br/>
pe_unmapper -https://github.com/hasherezade/libpeconv/tree/master/pe_unmapper<br/>
CAPA - https://github.com/fireeye/capa<br/>
IDA Free/Pro - https://hex-rays.com/ida-free/<br/>
Ghidra - https://ghidra-sre.org/<br/>
Cutter - https://cutter.re/<br/>
x64dbg - https://x64dbg.com<br/>
PE-bear - https://github.com/hasherezade/pe-bear-releases<br/>
pestudio - https://www.winitor.com/<br/>
CFF Explorer - https://ntcore.com/?page_id=388<br/>
ResourceHacker - http://www.angusj.com/resourcehacker/<br/>
Floss - https://github.com/fireeye/flare-floss<br/>
Strings2 - https://github.com/glmcdona/strings2<br/>
FlareStrings - https://github.com/fireeye/stringsifter<br/>
StringSifter - https://github.com/fireeye/stringsifter<br/>


