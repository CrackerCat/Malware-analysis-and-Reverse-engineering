# LokiBot Analyzing

The same sample of LokiBot is used in all three parts.<br/>
Sample of original LokiBot MD5: 5A50DA910E7220FC790313F37C79A6C1<br/>
### Download here:<br/>
[[Github - Pass:infected]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/Lokibot_Analyzing/LokiBot_original.7z)<br/>
[[ANYRUN - Pass:infected]](https://app.any.run/tasks/19740a7f-9666-4e4d-b671-a3b3224b740b/)<br/>
[[TRIA.GE - Pass:infected]](https://tria.ge/210629-e22q66qame)<br/>

### Brief Information:<br/>
This LokiBot sample is delivered via GULoader downloader.<br/>
GULoader is well known downloader written in assembly and wrapped in VB5/6 executable.<br/>
LokiBot is well known password stealer.<br/>
More Info GULoader: [[Malpedia - GULoader]](https://malpedia.caad.fkie.fraunhofer.de/details/win.cloudeye)<br/>
More Info LokiBot: [[Malpedia - LokiBot]](https://malpedia.caad.fkie.fraunhofer.de/details/win.lokipws)<br/>

## [1] Lokibot analyzing - defeating GuLoader with Windbg (Kernel debugging) and Live C2<br/>

Video: [[[1] Lokibot analyzing - defeating GuLoader with Windbg (Kernel debugging) and Live C2]](https://youtu.be/K3Yxu_9OUxU)<br/>
<br/>
Eventhough GULoader is performing many Anti-Debug and Anti-VM checks, this sample is not cheking Virtualbox VM and Kernel debugger. So we can simply defeat the GULoader Anti-Debug with Remote Kernel debugging in Virtualbox Guest VM.<br/>

### Steps Covered in Video:<br/>
Setting up WINDBG Preview and VirtualBox for Remote Kernel Debugging:<br/>
Guest VM:<br/>
CMD as administrator:<br/>
bcdedit /debug on<br/>
bcdedit /dbgsettings serial debugport:1 baudrate:115200 (assuming the port is COM1)<br/>
shut down the VM<br/>

HOST:<br/>
Go into the settings for our Virtualbox Windows VM:<br/>
Serial Ports -> Port1 -> Enable serial port<br/>
Port number COM1<br/>
Port Mode -> Host Pipe<br/>
Uncheck “Connect to existing pipe/socket”<br/>
Path/Address -> \\.\pipe\MalDBG<br/>
Start VM<br/>

Install Windbg Preview<br/>
Go to File -> "Start Debugging” and select “Attach to Kernel”<br/>
Go to COM tab -> Check Pipe and Reconnect<br/>
Resets 0<br/>
Baud Rate 115200<br/>
Port \\.\pipe\MalDBG
Uncheck Break on connection<br/>
Click OK - To attach to kernel of our VM<br/>


Attach windbg remote kernel debug.<br/>
Check all in Guest VM with processhacker or processexplorer.<br/>
Run LokiBot.<br/>
After spawning child process, suspend Guest VM in kernel debug.<br/>
!process 0 0 - list process and find LokiBot eprocess.<br/>
bu /p fffffa8005a13060 nt!NtTerminateProcess - breakpoint on LokiBot process termination (eprocess).<br/>
g - continue.<br/>
!process -1 0 - after reaching breakpoint on LokiBot process termination, confirm that we are in the LokiBot process context.<br/>
.reload - reload symbols after reaching breakpoint.<br/>
lmu - list usermode modules and note the start and end address of main LokiBot module.<br/>
.writemem C:\Users\DFIR_GUY\Desktop\lokibot\VIDEO\dumped\xxx.bin 0x00400000 0x004a2000 - save the memory range of main LokiBot module to file.<br/>
<br/>
Now we have unpacked LokiBot main module.<br/>
It is still mapped VA.<br/>
We can unmap it with pe_unmapper - pe_unmapper64.exe /in xxx.bin /base 400000 /out lokibot_unpacked.bin<br/>
Check repaired, unpacked, unmapped LokiBot with Pe-bear and strings<br/>
Unpacked, repaired, unmapped LokiBot: [[Github Download - Pass:infected]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/Lokibot_Analyzing/lokibot_unpacked.7z)<br/>

## [2] Lokibot analyzing - spoofing GULoader and LokiBot C2 [part1] - Own implementation in Python<br/>

Video: [[[2] Lokibot analyzing - spoofing GULoader and LokiBot C2 [part1] - Own implementation in Python]](https://youtu.be/-FxyzuRv6Wg)<br/>
<br/>
During my analysis the C2 was still active.<br/>
But in case the C2 becomes unreachable/down and we have the served payload, we can reimplement C2 functionality.<br/>
In this Video we are reimplementing the C2 in Python3.<br/>

All needed files (C2 Python Implemetation with certs) here: [[www folder]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/tree/main/Lokibot_Analyzing/www)<br/>
Served Encrypted LokiBot payload from Google drive here: [[encrypted_lokibot_downloaded_googledrive.bin]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/Lokibot_Analyzing/www/web/encrypted_lokibot_downloaded_googledrive.bin)<br/>

### Steps:<br/>
Run Wireshark + ProcessHacker and get Network IOCs from running LokiBot sample.<br/>

Network IOCs:<br/>
drive.google.com - encrypted payload delivery (GULoader C2)<br/>
63.141.228.141 - C2 exfiltrating stolen data (LokiBot C2)<br/>

#### Implementation steps for LokiBot C2:<br/>
There is a little problem that LokiBot is performing direct IP HTTP to C2 (In this case 63.141.228.141)<br/>
External IP redirection could be quite difficult on WindowsOS so we can cheat a little like this.<br/>
For simplicity (We can avoid direct IP (63.141.228.141) HTTP traffic redirection):<br/>

This will add IP 63.141.228.141 to LoopBack interface so our Loopback interface will have 2 IP assigned (127.0.0.1 and 63.141.228.141):<br/>
netsh interface ipv4 add address "Loopback" 63.141.228.141<br/>

To show all IPs assigned to our all interfaces (check loopback):<br/>
netsh interface ipv4 show addresses<br/>

Only for deleting the added IP 63.141.228.141 from LoopBack interface:<br/>
netsh interface ipv4 delete address "Loopback" 63.141.228.141<br/>

Now it is possible to run our Python C2 to be listening on IP 63.141.228.141 (IP of LokiBot C2)<br/>
<br/>
#### Implementation steps for GULoader C2:<br/>
GULoader is performing C2 HTTPS communication to drive.google.com with TLS.<br/>
We must spoof the certificate for "drive.google.com":<br/>
Generating Certificate + RSA private key in openssl for "drive.google.com:": “openssl req -new -x509 -keyout cert.pem -out cert.pem -nodes -days 365”:<br/>
Common name:drive.google.com<br/>

Redirect hostname "drive.google.com" to our newly assigned IP on LoopBack interface:<br/>
Add record to hosts file to redirect dns (drive.google.com):<br/>
63.141.228.141     drive.google.com<br/>

Import public cert "server.pem" (certmgr.msc) to "Trusted Root Certification Authorities"<br/>
<br/>
#### Finally jump to it:
Both Python C2 will listen on our newly assigned IP on LoopBack interface (63.141.228.141):<br/>
Run Python3 C2 for drive.google.com.[[HTTPS_WEB_SERVER_GET.py]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/Lokibot_Analyzing/www/HTTPS_WEB_SERVER_GET.py)<br/>
Run Python3 C2 for IP 63.141.228.141.[[HTTP_WEB_SERVER_POST.py]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/Lokibot_Analyzing/www/HTTP_WEB_SERVER_POST.py)<br/>

Run Wireshark (LoopBack) + ProcessHacker.<br/>
Run LokiBot sample.<br/>
Suspend LokiBot process (with ProcessHacker) after data exfiltration (HTTP POST to IP 63.141.228.141).<br/>
Dump the main module of LokiBot process 0x00400000 (Using ProcessHacker) -  Be careful about strange Memory protection N/A (Change it before dumping using ProcessHacker)<br/>
Use pe_unmapper - pe_unmapper64.exe /in xxx.bin /base 400000 /out lokibot_unpacked.bin<br/>
Check repaired, unpacked, unmapped LokiBot with Pe-bear and strings<br/>
Decrypt C2 communication to drive.google.com in Wireshark using privkey.pem<br/>

## [2] Lokibot analyzing - spoofing GULoader and LokiBot C2 [part2] - Inetsim + BurpSuite<br/>

Video: In process...<br/>
<br/>
Using Remnux as default Gateway + Inetsim + BurpSuite:<br/>
More here: https://medium.com/@atomixgray/basic-malware-lab-a021a6d639cb<br/>

Basically - Remnux is Dafault Gateway for Window VM victim<br/>
Inetsim is simulating DNS, HTTP, HTTPS etc...<br/>
Burpsuit is listening HTTPS/HTTP, for TLS it is generating Certificates on the fly according the requested host and redirecting to inetsim.<br/>
Inetsim is serving encrypted payload [[encrypted_lokibot_downloaded_googledrive.bin]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/Lokibot_Analyzing/www/web/encrypted_lokibot_downloaded_googledrive.bin)<br/>

Network IOCs:<br/>
drive.google.com - encrypted payload delivery (GULoader C2)<br/>
63.141.228.141 - C2 exfiltrating stolen data (LokiBot C2)<br/>
### Steps:<br/>

Remnux VM:<br/>
Rerouting all external IP, dst port 80 (example: 63.141.228.141 to localhost) - needed if no DNS is used and there is direct IP connection<br/>
Add:<br/>
sudo sysctl -w net.ipv4.conf.all.route_localnet=1  # to enable redirecting to localhost<br/>
sudo iptables -t nat -I PREROUTING -p tcp --dport 80 -j DNAT --to 127.0.0.1:80 <br/>

If you want to remove later:<br/>
sudo iptables -t nat -D PREROUTING -p tcp --dport 80 -j DNAT --to 127.0.0.1:80 <br/>

To be able to use InetSIM DNS server simulator you should disable systemd-resolved as this will conflict with InetSIMS.<br/>
Add:<br/>
sudo systemctl disable systemd-resolved.service<br/>
sudo service systemd-resolved stop<br/>


Inetsim:<br/>
modify config ("/etc/inetsim/inetsim.conf"):<br/>
start_service dns<br/>
service_bind_address	0.0.0.0<br/>
dns_default_ip		192.168.56.10<br/>
http_bind_port		8081<br/>
https_bind_port		8443<br/>
https_default_fakefile	encrypted_lokibot_downloaded_googledrive.bin	application/octet-stream<br/>
cp encrypted_lokibot_downloaded_googledrive.bin /var/lib/inetsim/http/fakefiles/encrypted_lokibot_downloaded_googledrive.bin<br/>

Burpsuite:<br/>
Proxy Listener options:<br/>
interface (all) *:443, redirect to localhost 8443, Check the box Support invisible proxying<br/>
interface (all) *:80 redirect to localhost 8081, Check the box Support invisible proxying<br/>
interface (all) *:8080  - for downloading the cert and importing as root trusted<br/>

Windows VM:<br/>
Virvtualbox HOST only adapter - the same as Remnux<br/>
Remnux IP - 192.168.56.10<br/>
Windows VM IP - 192.168.56.7<br/>

Change TCP/IP IPv4:<br/>
Static IP - 192.168.56.7<br/>
Gateway - 192.168.56.10<br/>
DNS - 192.168.56.10<br/>

Download burpsuite CA cert from 192.168.56.10:8080 and install it to "Trusted Root Certification Authorities"<br/>


Run LokiBot sample.<br/>
Suspend LokiBot process (with ProcessHacker) after data exfiltration (HTTP POST to IP 63.141.228.141).<br/>
Dump the main module of LokiBot process 0x00400000 (Using ProcessHacker) -  Be careful about strange Memory protection N/A (Change it before dumping using ProcessHacker)<br/>
Use pe_unmapper - pe_unmapper64.exe /in xxx.bin /base 400000 /out lokibot_unpacked.bin<br/>
Check repaired, unpacked, unmapped LokiBot with Pe-bear and strings<br/>
Check the Burpsuite in Remnux for all relevant Network traffic.<br/>


## [3] Lokibot analyzing - Reversing, API Hashing, decoding<br/>

Video: In process...<br/>


## References:
VirtualBox - https://www.virtualbox.org/wiki/Downloads<br/>
WinDbg Preview - https://www.microsoft.com/en-us/p/windbg-preview/9pgjgd53tn86?activetab=pivot:overviewtab<br/>
pe_unmapper -https://github.com/hasherezade/libpeconv/tree/master/pe_unmapper<br/>
PE-SIEVE - https://github.com/hasherezade/pe-sieve<br/>
PE-bear - https://github.com/hasherezade/pe-bear-releases<br/>
Strings Explorer Context - http://sandsprite.com/iDef/MAP/<br/>
IDA Free/Pro - https://hex-rays.com/ida-free/<br/>
Remnux - https://remnux.org/<br/>
INetSim - https://www.inetsim.org/<br/>
BurpSuite - https://portswigger.net/burp<br/>
OpenSSL - https://www.openssl.org/<br/>
Shellcode Hashes (Python2 Script + IDA Plugin) - https://github.com/fireeye/flare-ida<br/>
Wireshark - https://www.wireshark.org/download.html<br/>

