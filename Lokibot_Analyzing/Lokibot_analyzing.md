# LokiBot Analyzing

The same sample of LokiBot is used in all three parts.<br/>
Sample of original LokiBot MD5: 5A50DA910E7220FC790313F37C79A6C1 here:<br/>
[[Github - Pass:infected]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/Lokibot_Analyzing/LokiBot_original.7z)<br/>
[[ANYRUN - Pass:infected]](https://app.any.run/tasks/19740a7f-9666-4e4d-b671-a3b3224b740b/)<br/>
[[TRIA.GE - Pass:infected]](https://tria.ge/210629-e22q66qame)<br/>

Brief Information:<br/>
This LokiBot sample is deliver via GULoader downloader.<br/>
GULoader is well known downloader written in assembly and wrapped in VB5/6 executable.<br/>
LokiBot is well known password stealer.<br/>
More Info GULoader:[[Malpedia - GULoader]](https://malpedia.caad.fkie.fraunhofer.de/details/win.cloudeye)<br/>
More Info LokiBot:[[Malpedia - LokiBot]](https://malpedia.caad.fkie.fraunhofer.de/details/win.lokipws)<br/>

## [1] Lokibot analyzing - defeating GuLoader with Windbg (Kernel debugging) and Live C2<br/>

Video: In process...<br/>
<br/>
Eventhough GULoader is performing many Anti-Debug and Anti-VM checks, this sample is not cheking Virtualbox VM and Kernel debugger.<br/>
So we can simply defeat the GULoader Anti-Debug with Remote Kernel debugging in Virtualbox Guest VM.<br/>

Steps Covered in Video:<br/>
Setting up WINDBG Preview and VirtualBox for Remote Kernel Debugging.<br/>
Attach windbg remote kernel debug.<br/>
Check all in Guest VM with processhacker or processexplorer.<br/>
Run LokiBot.<br/>
After spawning child process, suspend Guest VM in kernel debug.<br/>
!process 0 0 - list process and find LokiBot eprocess.<br/>
bu /p fffffa8005a13060 nt!NtTerminateProcess - breakpoint on LokiBot process termination (eprocess).<br/>
g - continue.<br/>
!process -1 0 - after reaching breakpoint on LokiBot process termination, confirm that we are in the LokiBot process context.<br/>
.reload - reload symbols after reaching breakpoint.<br/>
lmu - list usermode modules and note the start and end address of main LokiBot module.<br/>
.writemem C:\Users\DFIR_GUY\Desktop\lokibot\VIDEO\dumped\xxx.bin 0x00400000 0x004a2000 - save the memory range of main LokiBot module to file.<br/>
<br/>
Now we have unpacked LokiBot main module.<br/>
It is still mapped VA.<br/>
We can unmap it with pe_unmapper - pe_unmapper64.exe /in xxx.bin /base 400000 /out lokibot_unpacked.bin<br/>
Check repaired, unpacked, unmapped LokiBot with Pe-bear and strings<br/>
Unpacked, repaired, unmapped LokiBot: [[Github Download - Pass:infected]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/Lokibot_Analyzing/lokibot_unpacked.7z)<br/>

## [2] Lokibot analyzing - spoofing GULoader C2 [part1] - Own implementation in Python<br/>

Video: In process...<br/>


## [2] Lokibot analyzing - spoofing GULoader C2 [part2] - Inetsim + BurpSuite<br/>

Video: In process...<br/>



## [3] Lokibot analyzing - Reversing, API Hashing, decoding<br/>

Video: In process...<br/>


## References:
VirtualBox - https://www.virtualbox.org/wiki/Downloads<br/>
WinDbg Preview - https://www.microsoft.com/en-us/p/windbg-preview/9pgjgd53tn86?activetab=pivot:overviewtab<br/>
pe_unmapper -https://github.com/hasherezade/libpeconv/tree/master/pe_unmapper<br/>
PE-SIEVE - https://github.com/hasherezade/pe-sieve<br/>
PE-bear - https://github.com/hasherezade/pe-bear-releases<br/>
Strings Explorer Context - http://sandsprite.com/iDef/MAP/<br/>
IDA Free/Pro - https://hex-rays.com/ida-free/<br/>
Remnux - https://remnux.org/<br/>
INetSim - https://www.inetsim.org/<br/>
BurpSuite - https://portswigger.net/burp<br/>
OpenSSL - https://www.openssl.org/<br/>
Shellcode Hashes (Python2 Script + IDA Plugin) - https://github.com/fireeye/flare-ida<br/>
Wireshark - https://www.wireshark.org/download.html<br/>

