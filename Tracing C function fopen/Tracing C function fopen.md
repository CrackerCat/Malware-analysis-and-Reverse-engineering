# Tracing C function fopen

Sample Available here: [[Sample fopen.exe]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/Tracing%20C%20function%20fopen/fopen.exe)<br/>
Debug symbols Available here: [[fopen.pdb]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/Tracing%20C%20function%20fopen/fopen.pdb)<br/>

fopen.exe - simply application in c utilazing fopen c function<br/>
ucrtbase.dll - C runtime library<br/>
ntoskrnl.exe (KERNEL Executive Subsystem part)<br/>


### Tracing C function fopen [Part1] - IDA Free User-Mode Walk-Through tracing to NTApi:<br/>

Execution flow:<br/>
fopen.exe calling fopen -> ucrtbase.dll;fopen -> ucrtbase.dll;_sopen_s -> ucrtbase.dll;_sopen_dispatch -> ucrtbase.dll;_sopen_nolock -> ucrtbase.dll;_wsopen_nolock -> kernel32.dll;CreateFileW -> kernelbase.dll;CreateFileW -> ntdll.dll;NtCreateFile -> ntdll.dll;KiFastSystemCall(0x52 - NtCreateFile) -> KERNEL Executive Subsystem

Video: [[Tracing C function fopen [Part1] - IDA Free User-Mode Walk-Through tracing to NTApi]](https://youtu.be/1HZCg1gVPpw)<br/>
<br/>


### Tracing C function fopen [Part2] - Windbg Kernel Debugging - Walk-Through User-Mode to Kernel Executive Subsytem:<br/>

Video:XXXXXXXX

#### Content:
Performing Remote live Kernel debugging with Windbg Preview.<br/>
Attach the Kernel debugger to process which have not started yet.<br/>
Stay in specified process context from User-Mode to Kernel-Mode.<br/>
Tracing Process.<br/>
Explaining what is System Service Number.<br/>
Investigate System Service Dispatch Table (SSDT).<br/>
Apply kernel function types in IDA.<br/>
Investigate interesting structures in Kernel.<br/>
Dig deeper.<br/>

#### Preparing Steps:<br/>
Prepare VM for Kernel debugging (32bit win7 to avoid wow64)<br/>
Disable ASLR in fopen.exe (NT Headers -> Optional Header -> DLL Characteristics -> DLL can move (Disable)<br/>
If symbols needed for fopen.exe - change .pdb path in debug directory of fopen.exe to point to your HOST fopen.pdb path<br/>
Prepare windbg preview for kernel debugging<br/>
Prepare IDA - ntoskrnl.exe (KERNEL Executive Subsystem part)<br/>

#### How to set VM and HOST for Kernel debugging using Windbg:
[[Kernel debugging Setup]](https://github.com/Dump-GUY/Malware-analysis-and-Reverse-engineering/blob/main/WINDBG%20Kernel%26User%20Mode%20Debugging/WINDBG%20Kernel%26User%20Mode%20Debugging.md
)<br/>

Walk-Through EXAMPLE:<br/>
fopen.exe calling fopen -> ucrtbase.dll;fopen -> ucrtbase.dll;_sopen_s -> ucrtbase.dll;_sopen_dispatch -> ucrtbase.dll;_sopen_nolock -> ucrtbase.dll;_wsopen_nolock -> kernel32.dll;CreateFileW -> kernelbase.dll;CreateFileW -> ntdll.dll;NtCreateFile -> ntdll.dll;KiFastSystemCall(0x42 - NtCreateFile) -> sysenter(x86) -> nt!IopCreateFile -> nt!ObOpenObjectByName -> ...........

#### Steps in WINDBG Preview:

